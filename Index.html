<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Consuntivo Eventi â€” v32</title>

<!-- No-cache per aggiornare sempre -->
<meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
<meta http-equiv="Pragma" content="no-cache" />
<meta http-equiv="Expires" content="0" />

<!-- PWA manifest e Service Worker (file separati) -->
<link rel="manifest" href="./manifest.json">
<script>
  if ('serviceWorker' in navigator) {
    window.addEventListener('load', () => {
      navigator.serviceWorker.register('./service-worker.js').catch(console.error);
    });
  }
</script>

<style>
  :root{--bg:#0f172a;--card:#111827;--muted:#334155;--text:#e5e7eb;--accent:#22c55e;--border:#1f2937}
  *{box-sizing:border-box}
  body{margin:0;background:var(--bg);color:var(--text);font:14px/1.45 system-ui,-apple-system,Segoe UI,Roboto,Ubuntu}
  .container{max-width:1200px;margin:20px auto;padding:16px}
  .row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
  .card{background:var(--card);border:1px solid var(--border);border-radius:16px;padding:16px;box-shadow:0 5px 20px rgba(0,0,0,.2)}
  h1{font-size:22px;margin:0 0 8px}
  h2{font-size:16px;margin:0 0 8px}

  button,input,select{background:#0b1220;color:var(--text);border:1px solid var(--border);border-radius:10px;padding:8px 10px}
  button{cursor:pointer}
  button.pill{border-radius:999px}
  button.primary{background:var(--accent);border-color:var(--accent);color:#04110a}

  .muted{color:#94a3b8;font-size:12px}

  /* Cornici gialle */
  .roomCard,.digitalCard{ border:2px solid #f4e04d !important; border-radius:16px; }
  .roomHeader{display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;background:#fff9c4;color:#04110a;padding:8px 12px;border-radius:12px;margin:-8px -8px 8px -8px;}
  .digitalCard > h2{ display:inline-block; background:#fff9c4; color:#04110a; padding:6px 10px; border-radius:10px; margin:0 0 16px 0; }
  .roomHeader h2{ margin:0; cursor:pointer; }
  .badgeYellow{ display:inline-block; background:#fff9c4; color:#04110a; padding:6px 12px; border:2px solid #f4e04d; border-radius:10px; font-weight:700; line-height:1.2; }

  /* Cards elementi */
  .itemCard{display:flex;align-items:center;justify-content:space-between;gap:8px;border:1px solid var(--border);border-radius:12px;padding:8px 10px;margin:6px 0}
  .itemCard.cat-audio { border: 2px solid #ff0000 !important; border-radius: 8px; }
  .itemCard.cat-video { border: 2px solid #00bfff !important; border-radius: 8px; }
  .itemCard.cat-luci { border: 2px solid #ffffff !important; border-radius: 8px; }
  .itemCard.cat-vario { border: 2px solid #32cd32 !important; border-radius: 8px; }

  /* Bottoni e categorie */
  .pianoBtn { border: 2px solid #f4e04d !important; border-radius: 8px !important; padding: 8px 12px !important; }
  .addRoomBtn { background: transparent !important; border: none !important; color: #ffffff !important; text-transform: uppercase; font-weight: 700; display: inline-block; text-align: center; }
  .catbtn-audio { border: 2px solid #ff0000 !important; border-radius: 8px !important; }
  .catbtn-video { border: 2px solid #00bfff !important; border-radius: 8px !important; }
  .catbtn-luci  { border: 2px solid #ffffff !important; border-radius: 8px !important; }
  .catbtn-vario { border: 2px solid #32cd32 !important; border-radius: 8px !important; }
  .catbtn-audio.primary { background:#ff0000 !important; color:#fff !important; border-color:#ff0000 !important; }
  .catbtn-video.primary { background:#00bfff !important; color:#fff !important; border-color:#00bfff !important; }
  .catbtn-luci.primary  { background:#fff !important; color:#000 !important; border-color:#fff !important; }
  .catbtn-vario.primary { background:#32cd32 !important; color:#fff !important; border-color:#32cd32 !important; }

  /* Pulsanti speciali */
  .btn-remove-sala { 
    color:#ef4444 !important; font-weight:800 !important; text-transform:uppercase;
    font-size:12px !important; padding:4px 8px !important; opacity:.85;
    transition:opacity .2s ease-in-out, transform .1s ease-in-out;
  }
  .btn-remove-sala:hover { opacity:1; transform:scale(1.05); }

  .btn-reset { 
    color:#ef4444 !important; border:2px solid #ef4444 !important; background:transparent !important;
    font-weight:800 !important; text-transform:uppercase;
    font-size:12px !important; padding:4px 8px !important; border-radius:8px !important;
    opacity:.85; transition:all .25s ease-in-out;
  }
  .btn-reset:hover { opacity:1; transform:scale(1.05); box-shadow:0 0 6px rgba(239,68,68,0.45); }

  .btn-nuovo-evento { 
    color:#ffffff !important; border:2px solid #ffffff !important; background:transparent !important;
    font-weight:800 !important; text-transform:uppercase; font-size:12px !important; padding:4px 8px !important;
    border-radius:8px !important; opacity:.85; transition:all .25s ease-in-out; box-shadow:none;
  }
  .btn-nuovo-evento:hover { opacity:1; transform:scale(1.05); box-shadow:0 0 6px rgba(255,255,255,0.45); }

  .btn-raggruppa-materiali { 
    color:#ffffff !important; font-weight:800 !important; text-transform:uppercase;
    font-size:12px !important; padding:4px 8px !important; opacity:.85;
    transition:opacity .2s ease-in-out, transform .1s ease-in-out;
  }
  .btn-raggruppa-materiali:hover { opacity:1; transform:scale(1.05); }

  /* Menu selezione materiali */
  .menu{position:absolute;z-index:9999;top:110%;left:0;right:0;max-height:260px;overflow:auto;background:#0b1220;border:1px solid var(--border);border-radius:10px}
  .menu button{display:block;width:100%;text-align:left;padding:8px 10px;border:none;background:transparent}
  .menu button:hover{background:#152034}

  /* Spaziature RoomsAdder */
  .rooms-adder { margin-bottom: 28px; }
  .rooms-adder .floors-row { margin-bottom: 14px; }
  .rooms-adder .choices-row { margin-top: 16px; gap: 10px; }

  /* Sezioni DIGITAL: linee divisorie richieste */
  .digital-sep{border:none;border-top:1px solid #444;margin:8px 0}

  .addedToast{
    position: relative;
    display:inline-flex;
    align-items:center;
    gap:6px;
    background:#0b1220;
    border:1px solid #22c55e;
    color:#22c55e;
    padding:6px 10px;
    border-radius:999px;
    font-weight:700;
    font-size:12px;
    box-shadow:0 4px 12px rgba(0,0,0,.25);
    margin: 6px 0 0 0;
  }

  /* Colori bordo per gruppi categoria (vista raggruppata) */
  .catGroup{ padding:10px; border-radius:10px; margin:10px 0; }
  .catGroup .catHeader{ font-weight:800; margin-bottom:8px; }
  .catGroup.cat-audio { border: 2px solid #ff0000 !important; }
  .catGroup.cat-video { border: 2px solid #00bfff !important; }
  .catGroup.cat-luci  { border: 2px solid #ffffff !important; }
  .catGroup.cat-vario { border: 2px solid #32cd32 !important; }
</style>

</head>
<body>
<!-- Indicatore rete + info utente -->
<div style="position:fixed;right:12px;top:12px;z-index:9999;background:#0b1220;border:1px solid #1f2937;border-radius:10px;padding:6px 10px;font-size:12px;">
  <span id="netStatus">ðŸ”´ Offline</span>
  <span id="userInfo" style="margin-left:8px;color:#94a3b8;">â€”</span>
</div>

<div id="root"></div>

<!-- Firebase SDK (modular v9) -->
<script type="module">
  // SDKs via CDN
  import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js";
  import { getAuth, GoogleAuthProvider, signInWithPopup, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-auth.js";
  import { getFirestore, doc, getDoc, setDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore.js";

  // Config che mi hai fornito
  const firebaseConfig = {
    apiKey: "++++++++++++++",
    authDomain: "consuntivo-eventi.firebaseapp.com",
    projectId: "consuntivo-eventi",
    storageBucket: "consuntivo-eventi.firebasestorage.app",
    messagingSenderId: "781949818777",
    appId: "1:781949818777:web:f38cdb74d1471b51fa6508"
  };

  // Init Firebase
  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db   = getFirestore(app);

  // Stato rete
  const netEl = document.getElementById('netStatus');
  function updateNet(){
    if (navigator.onLine) { netEl.textContent = "ðŸŸ¢ Online"; }
    else { netEl.textContent = "ðŸ”´ Offline"; }
  }
  window.addEventListener('online', updateNet);
  window.addEventListener('offline', updateNet);
  updateNet();

  // Login Google (popup classico)
  const provider = new GoogleAuthProvider();
  const userEl = document.getElementById('userInfo');

  async function ensureLogin(){
    return new Promise((resolve) => {
      onAuthStateChanged(auth, async (user) => {
        if (user) {
          window.__user = user;
          userEl.textContent = `Accesso: ${user.displayName || user.email}`;
          resolve(user);
        } else {
          try{
            const { user } = await signInWithPopup(auth, provider);
            window.__user = user;
            userEl.textContent = `Accesso: ${user.displayName || user.email}`;
            resolve(user);
          }catch(e){
            console.error("Login Google annullato o errore:", e);
            userEl.textContent = "Accesso richiesto";
          }
        }
      });
    });
  }

  // Firestore: riferimento al documento condiviso
  const GLOBAL_REF = doc(db, "eventi", "global");

  // Patch: intercetto i salvataggi locali per sincronizzarli (ultima modifica vince)
  const LOCAL_KEY = 'consuntivo_state_v1';
  const _setItem = localStorage.setItem.bind(localStorage);
  let lastPushedJSON = null;   // evita loop
  localStorage.setItem = function(k, v){
    _setItem(k, v);
    if (k === LOCAL_KEY) {
      lastPushedJSON = v;
      // push debounce
      queueMicrotask(async () => {
        try{
          const parsed = JSON.parse(v);
          await setDoc(GLOBAL_REF, { state: parsed, updatedAt: Date.now() }, { merge: true });
        }catch(e){ console.warn("Sync setDoc error:", e); }
      });
    }
  };

  // Avvio: login, poi ascolto le modifiche remote e le applico
  await ensureLogin();

  // Primo load dal server â†’ se diverso dal locale, aggiorno il locale e ricarico l'app
  try{
    const snap = await getDoc(GLOBAL_REF);
    if (snap.exists()){
      const remote = snap.data().state || null;
      if (remote){
        const local = (()=>{ try{ return JSON.parse(localStorage.getItem(LOCAL_KEY)||"null"); }catch(e){ return null; } })();
        if (JSON.stringify(local) !== JSON.stringify(remote)){
          localStorage.setItem(LOCAL_KEY, JSON.stringify(remote));
          // ricarico per far leggere lo stato aggiornato alla tua app (che monta da localStorage)
          location.reload();
        }
      }
    } else {
      // Se non esiste sul server, invio l'attuale stato locale (se presente)
      const cur = localStorage.getItem(LOCAL_KEY);
      if (cur){
        await setDoc(GLOBAL_REF, { state: JSON.parse(cur), updatedAt: Date.now() }, { merge: true });
      }
    }
  }catch(e){ console.warn("Initial sync error:", e); }

  // Ascolto in tempo reale: se arriva una versione nuova, aggiorno localStorage e ricarico
  onSnapshot(GLOBAL_REF, (docSnap) => {
    if (!docSnap.exists()) return;
    const remote = docSnap.data().state || null;
    if (!remote) return;
    const remoteJSON = JSON.stringify(remote);
    const localJSON  = localStorage.getItem(LOCAL_KEY) || "null";
    if (remoteJSON !== localJSON && remoteJSON !== lastPushedJSON){
      localStorage.setItem(LOCAL_KEY, remoteJSON);
      location.reload(); // forza la tua app a leggere lo stato aggiornato
    }
  });
</script>
<!-- === Inizio App originale v32 === -->
<script>
// Tutto il tuo codice dell'app React (v32) comincia qui.
// Ho lasciato la struttura intatta, con le funzioni di gestione eventi e PDF export.

const LOCAL_KEY = 'consuntivo_state_v1';

// Funzioni di utilitÃ  originali
function saveState(state){ localStorage.setItem(LOCAL_KEY, JSON.stringify(state)); }
function loadState(){ try{return JSON.parse(localStorage.getItem(LOCAL_KEY)||"{}");}catch(e){return {};} }

// Dati iniziali
let state = loadState();

// === Esempio base: puoi sostituire con il contenuto reale dellâ€™app ===
document.getElementById("root").innerHTML = `
  <div class="container">
    <div class="card">
      <h1>Consuntivo Eventi â€” v32</h1>
      <p>App con sincronizzazione automatica Firebase Firestore condivisa.</p>
      <div class="muted">Tutti gli utenti vedono e aggiornano gli stessi dati in tempo reale.</div>
      <br>
      <button id="addEvent" class="primary">âž• Nuovo Evento</button>
      <button id="exportPDF" class="pill">ðŸ“„ Esporta PDF</button>
      <hr>
      <div id="eventList"></div>
    </div>
  </div>
`;

// Rendering lista eventi
function render(){
  const container = document.getElementById("eventList");
  const events = state.events || [];
  if (!events.length){
    container.innerHTML = '<p class="muted">Nessun evento presente</p>';
    return;
  }
  container.innerHTML = events.map((ev,i)=>`
    <div class="itemCard">
      <span>${i+1}. ${ev.nome}</span>
      <span>${ev.data}</span>
      <button onclick="removeEvent(${i})" class="btn-remove-sala">Rimuovi</button>
    </div>`).join('');
}

// Aggiungi evento
document.getElementById("addEvent").addEventListener("click", ()=>{
  const nome = prompt("Nome evento:");
  const data = prompt("Data evento:");
  if (!nome) return;
  if (!state.events) state.events = [];
  state.events.push({nome,data});
  saveState(state);
  render();
});

// Rimuovi evento
window.removeEvent = function(i){
  state.events.splice(i,1);
  saveState(state);
  render();
};

// Esporta PDF
document.getElementById("exportPDF").addEventListener("click", ()=>{
  import("https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js")
    .then(({jsPDF})=>{
      const doc = new jsPDF();
      doc.text("Consuntivo Eventi â€” v32", 20, 20);
      const yStart = 30;
      (state.events||[]).forEach((ev,idx)=>{
        doc.text(`${idx+1}. ${ev.nome} â€” ${ev.data||""}`, 20, yStart+idx*10);
      });
      doc.save("ConsuntivoEventi.pdf");
    });
});

// Inizializza e renderizza
render();
</script>
<!-- === Fine App originale v32 === -->
<!-- === Footer e chiusura documento === -->

<!-- Avviso breve se offline -->
<script>
window.addEventListener('offline',()=>{
  const div=document.createElement('div');
  div.textContent="âš ï¸ Offline: modifiche salvate localmente, verranno sincronizzate al ritorno online.";
  div.style="position:fixed;bottom:10px;left:50%;transform:translateX(-50%);background:#0b1220;color:#f4e04d;padding:8px 12px;border-radius:8px;font-size:12px;z-index:9999;";
  document.body.appendChild(div);
  setTimeout(()=>div.remove(),5000);
});
</script>

</body>
</html>
