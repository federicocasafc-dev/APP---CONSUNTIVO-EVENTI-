<!DOCTYPE html>
<html lang="it">
<head>
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
<meta http-equiv="Pragma" content="no-cache" />
<meta http-equiv="Expires" content="0" />
<script>try{ fetch(window.location.href, {cache:"no-store"}); }catch(e){}</script>
  <link rel="manifest" href="data:application/json,{&quot;name&quot;: &quot;Consuntivo Eventi&quot;, &quot;short_name&quot;: &quot;Eventi&quot;, &quot;start_url&quot;: &quot;/APP---CONSUNTIVO-EVENTI-&quot;, &quot;scope&quot;: &quot;/APP---CONSUNTIVO-EVENTI-&quot;, &quot;display&quot;: &quot;standalone&quot;, &quot;background_color&quot;: &quot;#0f172a&quot;, &quot;theme_color&quot;: &quot;#0f172a&quot;, &quot;icons&quot;: [{&quot;src&quot;: &quot;images.png&quot;, &quot;sizes&quot;: &quot;512x512&quot;, &quot;type&quot;: &quot;image/png&quot;}]}">
  <script>
if ('serviceWorker' in navigator) {
  const code = "
const CACHE_NAME = 'consuntivo-eventi-cache-v20251112170344';
const BASE = '/APP---CONSUNTIVO-EVENTI-';
const TO_CACHE = [\"/APP---CONSUNTIVO-EVENTI-\", \"/APP---CONSUNTIVO-EVENTI-index.html\", \"/APP---CONSUNTIVO-EVENTI-images.png\", \"https://unpkg.com/react@18/umd/react.development.js\", \"https://unpkg.com/react-dom@18/umd/react-dom.development.js\", \"https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js\", \"https://cdn.jsdelivr.net/npm/jspdf-autotable@3.8.2/dist/jspdf.plugin.autotable.min.js\"];

self.addEventListener('install', (e) => {
  e.waitUntil(
    caches.open(CACHE_NAME).then(cache => cache.addAll(TO_CACHE))
      .then(() => self.skipWaiting())
  );
});

self.addEventListener('activate', (e) => {
  e.waitUntil(
    caches.keys().then(keys => Promise.all(keys.map(k => k !== CACHE_NAME && caches.delete(k)))).then(() => self.clients.claim())
  );
});

self.addEventListener('fetch', (e) => {
  const req = e.request;
  const accept = req.headers.get('accept') || '';
  const isHTML = accept.includes('text/html');
  if (isHTML) {
    e.respondWith(
      fetch(req, { cache: 'no-store' })
        .then(resp => {
          const clone = resp.clone();
          caches.open(CACHE_NAME).then(c => c.put(req, clone));
          return resp;
        })
        .catch(() => caches.match(req).then(r => r || caches.match(BASE + 'index.html')))
    );
  } else {
    e.respondWith(
      caches.match(req).then(r => r || fetch(req).then(resp => {
        const clone = resp.clone();
        caches.open(CACHE_NAME).then(c => c.put(req, clone));
        return resp;
      }).catch(() => caches.match(req)))
    );
  }
});
";
  const blob = new Blob([code], { type: 'application/javascript' });
  const url = URL.createObjectURL(blob);
  navigator.serviceWorker.register(url).catch(console.error);
}
</script>

<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Consuntivo Eventi</title>
<style>
  :root{--bg:#0f172a;--card:#111827;--muted:#334155;--text:#e5e7eb;--accent:#22c55e;--border:#1f2937}
  *{box-sizing:border-box}
  body{margin:0;background:var(--bg);color:var(--text);font:14px/1.45 system-ui,-apple-system,Segoe UI,Roboto,Ubuntu}
  .container{max-width:1200px;margin:20px auto;padding:16px}
  .row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
  .card{background:var(--card);border:1px solid var(--border);border-radius:16px;padding:16px;box-shadow:0 5px 20px rgba(0,0,0,.2)}
  h1{font-size:22px;margin:0 0 8px}
  h2{font-size:16px;margin:0 0 8px}

  button,input,select{background:#0b1220;color:var(--text);border:1px solid var(--border);border-radius:10px;padding:8px 10px}
  button{cursor:pointer}
  button.pill{border-radius:999px}
  button.primary{background:var(--accent);border-color:var(--accent);color:#04110a}

  .muted{color:#94a3b8;font-size:12px}

  /* Cornici gialle */
  .roomCard,.digitalCard{ border:2px solid #f4e04d !important; border-radius:16px; }
  .roomHeader{display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;background:#fff9c4;color:#04110a;padding:8px 12px;border-radius:12px;margin:-8px -8px 8px -8px;}
  .digitalCard > h2{ display:inline-block; background:#fff9c4; color:#04110a; padding:6px 10px; border-radius:10px; margin:0 0 16px 0; }
  .roomHeader h2{ margin:0; cursor:pointer; }
  .badgeYellow{ display:inline-block; background:#fff9c4; color:#04110a; padding:6px 12px; border:2px solid #f4e04d; border-radius:10px; font-weight:700; line-height:1.2; }

  /* Cards elementi */
  .itemCard{display:flex;align-items:center;justify-content:space-between;gap:8px;border:1px solid var(--border);border-radius:12px;padding:8px 10px;margin:6px 0}
  .itemCard.cat-audio { border: 2px solid #ff0000 !important; border-radius: 8px; }
  .itemCard.cat-video { border: 2px solid #00bfff !important; border-radius: 8px; }
  .itemCard.cat-luci { border: 2px solid #ffffff !important; border-radius: 8px; }
  .itemCard.cat-vario { border: 2px solid #32cd32 !important; border-radius: 8px; }

  /* Bottoni e categorie */
  .pianoBtn { border: 2px solid #f4e04d !important; border-radius: 8px !important; padding: 8px 12px !important; }
  .addRoomBtn { background: transparent !important; border: none !important; color: #ffffff !important; text-transform: uppercase; font-weight: 700; display: inline-block; text-align: center; }
  .catbtn-audio { border: 2px solid #ff0000 !important; border-radius: 8px !important; }
  .catbtn-video { border: 2px solid #00bfff !important; border-radius: 8px !important; }
  .catbtn-luci  { border: 2px solid #ffffff !important; border-radius: 8px !important; }
  .catbtn-vario { border: 2px solid #32cd32 !important; border-radius: 8px !important; }
  .catbtn-audio.primary { background:#ff0000 !important; color:#fff !important; border-color:#ff0000 !important; }
  .catbtn-video.primary { background:#00bfff !important; color:#fff !important; border-color:#00bfff !important; }
  .catbtn-luci.primary  { background:#fff !important; color:#000 !important; border-color:#fff !important; }
  .catbtn-vario.primary { background:#32cd32 !important; color:#fff !important; border-color:#32cd32 !important; }

  /* Pulsanti speciali */
  .btn-remove-sala { 
    color:#ef4444 !important; font-weight:800 !important; text-transform:uppercase;
    font-size:12px !important; padding:4px 8px !important; opacity:.85;
    transition:opacity .2s ease-in-out, transform .1s ease-in-out;
  }
  .btn-remove-sala:hover { opacity:1; transform:scale(1.05); }

  .btn-reset { 
    color:#ef4444 !important; border:2px solid #ef4444 !important; background:transparent !important;
    font-weight:800 !important; text-transform:uppercase;
    font-size:12px !important; padding:4px 8px !important; border-radius:8px !important;
    opacity:.85; transition:all .25s ease-in-out;
  }
  .btn-reset:hover { opacity:1; transform:scale(1.05); box-shadow:0 0 6px rgba(239,68,68,0.45); }

  .btn-nuovo-evento { 
    color:#ffffff !important; border:2px solid #ffffff !important; background:transparent !important;
    font-weight:800 !important; text-transform:uppercase; font-size:12px !important; padding:4px 8px !important;
    border-radius:8px !important; opacity:.85; transition:all .25s ease-in-out; box-shadow:none;
  }
  .btn-nuovo-evento:hover { opacity:1; transform:scale(1.05); box-shadow:0 0 6px rgba(255,255,255,0.45); }

  .btn-raggruppa-materiali { 
    color:#ffffff !important; font-weight:800 !important; text-transform:uppercase;
    font-size:12px !important; padding:4px 8px !important; opacity:.85;
    transition:opacity .2s ease-in-out, transform .1s ease-in-out;
  }
.btn-raggruppa-materiali:hover { opacity:1; transform:scale(1.05); }


  /* Menu selezione materiali */
  .menu{position:absolute;z-index:9999;top:110%;left:0;right:0;max-height:260px;overflow:auto;background:#0b1220;border:1px solid var(--border);border-radius:10px}
  .menu button{display:block;width:100%;text-align:left;padding:8px 10px;border:none;background:transparent}
  .menu button:hover{background:#152034}

  /* Spaziature RoomsAdder */
  .rooms-adder { margin-bottom: 28px; }
  .rooms-adder .floors-row { margin-bottom: 14px; }
  .rooms-adder .choices-row { margin-top: 16px; gap: 10px; }

  /* Sezioni DIGITAL: linee divisorie richieste */
  .digital-sep{border:none;border-top:1px solid #444;margin:8px 0}

  .addedToast{
    position: relative;
    display:inline-flex;
    align-items:center;
    gap:6px;
    background:#0b1220;
    border:1px solid #22c55e;
    color:#22c55e;
    padding:6px 10px;
    border-radius:999px;
    font-weight:700;
    font-size:12px;
    box-shadow:0 4px 12px rgba(0,0,0,.25);
    margin: 6px 0 0 0;
  }

  /* Colori bordo per gruppi categoria (vista raggruppata) */
  .catGroup{ padding:10px; border-radius:10px; margin:10px 0; }
  .catGroup .catHeader{ font-weight:800; margin-bottom:8px; }
  .catGroup.cat-audio { border: 2px solid #ff0000 !important; }
  .catGroup.cat-video { border: 2px solid #00bfff !important; }
  .catGroup.cat-luci  { border: 2px solid #ffffff !important; }
  .catGroup.cat-vario { border: 2px solid #32cd32 !important; }
</style>
</head>
<body>
<div id="root"></div>

<script>
  const CATALOG = [{"name": "DIGITAL BASE", "unitPrice": 100.0}, {"name": "DIGITAL PREMIUM", "unitPrice": 200.0}, {"name": "DIGITAL PREMIUM PLUS", "unitPrice": 350.0}, {"name": "LEDWALL A", "unitPrice": 200.0}, {"name": "LEDWALL B", "unitPrice": 150.0}, {"name": "MONITOR FOYER A -SEGNALETICA", "unitPrice": 100.0}, {"name": "MONITOR FOYER A -ACCREDITI", "unitPrice": 100.0}, {"name": "SUBWOOFER 2/4 (cad)", "unitPrice": 50.0}, {"name": "SCHEDE ACQUISIZIONE AUDIO USB", "unitPrice": 50.0}, {"name": "RADIOMICROFONI", "unitPrice": 30.0}, {"name": "HEADSET", "unitPrice": 50.0}, {"name": "CABINE TRADUZIONE PIAZZA/ANFI", "unitPrice": 300.0}, {"name": "CABINE TRADUZIONE - ARENG/CAST/TEMPIO", "unitPrice": 200.0}, {"name": "CABINE TRADUZIONE - BO/PAR/MAR/PON/POR/ARCO", "unitPrice": 400.0}, {"name": "RICEVITORI TRADUZIONE", "unitPrice": 1.0}, {"name": "OVERSOUND", "unitPrice": 300.0}, {"name": "REGISTRAZIONE AUDIO", "unitPrice": 100.0}, {"name": "XLR AUDIO (MIXER - CAM)", "unitPrice": 50.0}, {"name": "MIXER DIGITALE + TIO/RIO", "unitPrice": 300.0}, {"name": "SETTAGGIO AUDIO ANFI", "unitPrice": 300.0}, {"name": "CABLAGGIO PALCO ANFI", "unitPrice": 400.0}, {"name": "SETTAGGIO AUDIO PIAZZA", "unitPrice": 350.0}, {"name": "CABLAGGIO PALCO PIAZZA", "unitPrice": 500.0}, {"name": "IMPIANTO AUDIO EVAC", "unitPrice": 200.0}, {"name": "IMPIANTO AUDIO 2 CASSE + MIC", "unitPrice": 300.0}, {"name": "IMPIANTO AUDIO 6 CASSE + MIC", "unitPrice": 600.0}, {"name": "MUSICA TOTEM SU RICHIESTA", "unitPrice": 50.0}, {"name": "BARRE LED (10PZ)", "unitPrice": 100.0}, {"name": "CONCHIGLIA COLORATA", "unitPrice": 50.0}, {"name": "MIXER LUCI", "unitPrice": 100.0}, {"name": "MONITOR 24\" a terra", "unitPrice": 50.0}, {"name": "MONITOR 40\" a terra", "unitPrice": 100.0}, {"name": "MONITOR 55\" su stativo", "unitPrice": 150.0}, {"name": "MONITOR 65\"TOUCH su stativo", "unitPrice": 250.0}, {"name": "RIMANDI VIDEO SALE  CON PC", "unitPrice": 150.0}, {"name": "RIMANDI VIDEO CON FIBRA OTTICA", "unitPrice": 250.0}, {"name": "MICRO CUE", "unitPrice": 100.0}, {"name": "LAPTOP (PC)", "unitPrice": 50.0}, {"name": "VIDEOPROIETTORI 14K", "unitPrice": 150.0}, {"name": "RALLYBAR VIDEOCONFERENCE", "unitPrice": 300.0}, {"name": "VECCHIA PESCHERIA RALLYBAR", "unitPrice": 300.0}, {"name": "OWL VIDEOCONFERENCE", "unitPrice": 100.0}, {"name": "ANFITEATRO BASE (2k - schermo base 8 mt. con frame)", "unitPrice": 2000.0}, {"name": "ANFITEATRO PLUS (4k - schermo base 9mt. No frame)", "unitPrice": 2000.0}, {"name": "PIAZZA BASE (2k - schermo base 8 mt. con frame)", "unitPrice": 3000.0}, {"name": "PIAZZA PLUS (4k - schermo base 9mt. No frame)", "unitPrice": 6000.0}, {"name": "LAVAGNE A FOGLI MOBILI", "unitPrice": 50.0}, {"name": "COUNT DOWN TIMER", "unitPrice": 100.0}, {"name": "COUNT DOWN SU MON. VIDEO", "unitPrice": 150.0}, {"name": "ABAT-JOUR", "unitPrice": 30.0},
  {"name":"VISUALIZZAZIONE RELATORE","unitPrice":50.0},
  {"name":"ATEM MINI / SWITCH VIDEO / SCALER","unitPrice":40.0},
  {"name":"SWITCH DI RETE","unitPrice":20.0}
  ];

  const CATEGORY_CATALOG = {
    AUDIO: [
      { name: 'SUBWOOFER 2/4 (cad)', unitPrice: 50 },
      { name: 'SCHEDE ACQUISIZIONE AUDIO USB', unitPrice: 50 },
      { name: 'RADIOMICROFONI', unitPrice: 30 },
      { name: 'HEADSET', unitPrice: 50 },
      { name: 'CABINE TRADUZIONE PIAZZA/ANFI', unitPrice: 300 },
      { name: 'CABINE TRADUZIONE - ARENG/CAST/TEMPIO', unitPrice: 200 },
      { name: 'CABINE TRADUZIONE - BO/PAR/MAR/PON/POR/ARCO', unitPrice: 400 },
      { name: 'RICEVITORI TRADUZIONE', unitPrice: 1 },
      { name: 'OVERSOUND', unitPrice: 300 },
      { name: 'REGISTRAZIONE AUDIO', unitPrice: 100 },
      { name: 'XLR AUDIO (MIXER - CAM)', unitPrice: 50 },
      { name: 'MIXER DIGITALE + TIO/RIO', unitPrice: 300 },
      { name: 'SETTAGGIO AUDIO ANFI', unitPrice: 300 },
      { name: 'CABLAGGIO PALCO ANFI', unitPrice: 400 },
      { name: 'SETTAGGIO AUDIO PIAZZA', unitPrice: 350 },
      { name: 'CABLAGGIO PALCO PIAZZA', unitPrice: 500 },
      { name: 'IMPIANTO AUDIO EVAC', unitPrice: 200 },
      { name: 'IMPIANTO AUDIO 2 CASSE + MIC', unitPrice: 300 },
      { name: 'IMPIANTO AUDIO 6 CASSE + MIC', unitPrice: 600 },
      { name: 'MUSICA TOTEM SU RICHIESTA', unitPrice: 50 }
    ],
    VIDEO: [
      { name: 'MONITOR 24\" a terra', unitPrice: 50 },
      { name: 'MONITOR 40\" a terra', unitPrice: 100 },
      { name: 'MONITOR 55\" su stativo', unitPrice: 150 },
      { name: 'MONITOR 65\"TOUCH su stativo', unitPrice: 250 },
      { name: 'RIMANDI VIDEO SALE  CON PC', unitPrice: 150 },
      { name: 'RIMANDI VIDEO CON FIBRA OTTICA', unitPrice: 250 },
      { name: 'MICRO CUE', unitPrice: 100 },
      { name: 'LAPTOP (PC)', unitPrice: 50 },
      { name: 'VIDEOPROIETTORI 14K', unitPrice: 150 },
      { name: 'RALLYBAR VIDEOCONFERENCE', unitPrice: 300 },
      { name: 'VECCHIA PESCHERIA RALLYBAR', unitPrice: 300 },
      { name: 'OWL VIDEOCONFERENCE', unitPrice: 100 },
      { name:'VISUALIZZAZIONE RELATORE', unitPrice:50 },
      { name:'ATEM MINI / SWITCH VIDEO / SCALER', unitPrice:40 }
    ],
    LUCI: [
      { name: 'BARRE LED (10PZ)', unitPrice: 100 },
      { name: 'CONCHIGLIA COLORATA', unitPrice: 50 },
      { name: 'MIXER LUCI', unitPrice: 100 }
    ],
    VARIO: [
      { name: 'ANFITEATRO BASE (2k - schermo base 8 mt. con frame)', unitPrice: 2000 },
      { name: 'ANFITEATRO PLUS (4k - schermo base 9mt. No frame)', unitPrice: 2000 },
      { name: 'PIAZZA BASE (2k - schermo base 8 mt. con frame)', unitPrice: 3000 },
      { name: 'PIAZZA PLUS (4k - schermo base 9mt. No frame)', unitPrice: 6000 },
      { name: 'LAVAGNE A FOGLI MOBILI', unitPrice: 50 },
      { name: 'COUNT DOWN TIMER', unitPrice: 100 },
      { name: 'COUNT DOWN SU MON. VIDEO', unitPrice: 150 },
      { name: 'ABAT-JOUR', unitPrice: 30 },
      { name:'SWITCH DI RETE', unitPrice:20 }
    ]
  };

  const DIGITAL_ORDER = [
    "DIGITAL BASE","DIGITAL PREMIUM","DIGITAL PREMIUM PLUS",
    "LEDWALL A","LEDWALL B",
    "MONITOR FOYER A -SEGNALETICA","MONITOR FOYER A -ACCREDITI"
  ];
  const DIGITAL_ITEMS = DIGITAL_ORDER.map(n=>{
    const it = CATALOG.find(x=>String(x.name).replace(' - ', '-').replace(' -','-')===String(n).replace(' - ', '-').replace(' -','-'));
    return {name:n, unitPrice: it ? it.unitPrice : 0};
  });
</script>

<!-- React -->
<script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
<script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>

<script type="text/javascript">
const {useMemo,useState,useEffect} = React;
const uid = ()=>Math.random().toString(36).slice(2,10);
const EUR = (n)=> (new Intl.NumberFormat('it-IT',{style:'currency',currency:'EUR'})).format(Number(n||0));
function deepClone(x){return JSON.parse(JSON.stringify(x));}

const LOCAL_KEY = 'consuntivo_state_v1';

function App(){
  const [events,setEvents] = useState(()=>{
    try{
      const raw = localStorage.getItem(LOCAL_KEY);
      if(raw){ const parsed = JSON.parse(raw); if(Array.isArray(parsed.events)) return parsed.events; }
    }catch(e){}
    return [{ id:uid(), name:'Esempio', rooms:[], itemsByRoom:{}, groupedRooms:{}, collapsedRooms:{}, digital:{} }];
  });
  const [activeId,setActiveId] = useState(events[0].id);
  const active = useMemo(()=> events.find(e=>e.id===activeId) || events[0], [events,activeId]);

  useEffect(()=>{
    try{ localStorage.setItem(LOCAL_KEY, JSON.stringify({events})); }catch(e){}
    try{ window.__CONSUNTIVO = { events, activeId }; }catch(e){}
    try{ window.__getModel = () => ({ name: active?.name || 'EVENTO', rooms: active?.rooms || [], itemsByRoom: active?.itemsByRoom || {}, digital: active?.digital || {} }); }catch(e){}
  }, [events, activeId, active]);

  function setEvent(next){
    const list = deepClone(events); const i=list.findIndex(e=>e.id===next.id); list[i]=next; setEvents(list);
  }
  function addEvent(){
    const name = prompt('Nome evento:', `Evento ${events.length+1}`); if(!name) return;
    const ev = { id:uid(), name, rooms:[], itemsByRoom:{}, groupedRooms:{}, collapsedRooms:{}, digital:{} };
    setEvents([...events, ev]); setActiveId(ev.id);
  }
  function removeEvent(id){
    if(!confirm('Eliminare questo evento?')) return;
    const next = events.filter(e=>e.id!==id); setEvents(next); setActiveId(next[0]?.id || null);
  }
  function addRoom(room){
    if(!room) return;
    if(active.rooms.includes(room)) return alert('Sala giÃ  presente');
    const next = deepClone(active);
    next.rooms.push(room);
    if(!next.itemsByRoom[room]) next.itemsByRoom[room]=[];
    if(!next.groupedRooms) next.groupedRooms = {};
    if(!next.collapsedRooms) next.collapsedRooms = {};
    next.groupedRooms[room] = true;    // default raggruppata
    next.collapsedRooms[room] = false; // visibile
    setEvent(next);
  }
  function removeRoom(room){
    const next = deepClone(active);
    next.rooms = next.rooms.filter(r=>r!==room);
    delete next.itemsByRoom[room];
    if(next.groupedRooms) delete next.groupedRooms[room];
    if(next.collapsedRooms) delete next.collapsedRooms[room];
    setEvent(next);
  }
  function updateQty(room, itemId, qty){
    const next = deepClone(active);
    const list = next.itemsByRoom[room]||[];
    const it = list.find(x=>x.id===itemId); if(it) it.qty = qty;
    setEvent(next);
  }
  function removeItem(room, itemId){
    const next = deepClone(active);
    next.itemsByRoom[room] = (next.itemsByRoom[room]||[]).filter(x=>x.id!==itemId);
    setEvent(next);
  }
  function addItemToRoom(room, item){
    const next = deepClone(active);
    const list = next.itemsByRoom[room] || (next.itemsByRoom[room]=[]);
    if(!list.find(x=>x.name===item.name)){
      const cat = (item._category || item.category || null);
      list.push({ id:uid(), name:item.name, unitPrice:item.unitPrice, qty:1, category: cat });
      setEvent(next);
    }
  }

  function digitalSum(ev){
    if(!ev || !ev.digital) return 0;
    const names = DIGITAL_ORDER;
    const priceByName = Object.fromEntries((CATALOG||[]).map(it=>[String(it.name), Number(it.unitPrice||0)]));
    return names.reduce((s,n)=> s + (ev.digital[n] ? (priceByName[n]||0) : 0), 0);
  }

  const totalEvent = useMemo(
    () => (active?.rooms||[]).reduce((a, r) => a + (active.itemsByRoom[r]||[]).reduce((s,it)=>s + Number(it.qty||0)*Number(it.unitPrice||0), 0), 0) + digitalSum(active),
    [active]
  );

  function resetAll(){
    if(!confirm('Sicuro di azzerare tutto?')) return;
    setEvents([{ id:uid(), name:'Esempio', rooms:[], itemsByRoom:{}, groupedRooms:{}, collapsedRooms:{}, digital:{} }]);
    setActiveId(null);
    try{ localStorage.removeItem(LOCAL_KEY);}catch(e){}
  }

  return React.createElement('div',{className:'container'},
    React.createElement('div',{className:'row', style:{justifyContent:'space-between'}},
      React.createElement('h1',{className:'badgeYellow'},'CONSUNTIVO EVENTI'),
      React.createElement('div',{className:'row'},
        React.createElement('button',{className:'pill btn-reset', onClick:resetAll}, 'RESET ðŸ—‘ï¸'),
        React.createElement('button',{className:'pill btn-nuovo-evento', onClick:addEvent}, '+ NUOVO EVENTO')
      )
    ),

    React.createElement('div',{className:'card'},
      React.createElement('div',{className:'row', style:{marginBottom:24}},
        ...events.map(ev=>React.createElement('button',{key:ev.id, className: ev.id===active?.id ? 'pill primary' : 'pill', onClick:()=>setActiveId(ev.id)}, ev.name)),
        active ? React.createElement('button',{className:'pill', onClick:()=>removeEvent(active.id)}, 'Elimina evento') : null
      ),

      active ? React.createElement(React.Fragment,null,
        React.createElement('div',{className:'row', style:{margin:'8px 0'}},
          React.createElement('label',{style:{fontWeight:700}},'NOME EVENTO '),
          React.createElement('input',{value:active.name, onChange:(e)=>setEvent({...active, name:e.target.value})})
        ),

        React.createElement('div',{className:'card digitalCard', style:{marginTop:24, marginBottom:24}},
          React.createElement('h2',null,'DIGITAL'),
          ...(function(){
            const out=[];
            DIGITAL_ITEMS.forEach((it, idx)=>{
              if(it.name==='LEDWALL A' || it.name==='MONITOR FOYER A -SEGNALETICA'){
                out.push(React.createElement('hr',{key:it.name+'-sep', className:'digital-sep'}));
              }
              out.push(React.createElement('div',{key:it.name, className:'row', style:{justifyContent:'space-between', width:'100%'}},
                React.createElement('label',{className:'chip'},
                  React.createElement('input',{type:'checkbox', checked:Boolean((active.digital||{})[it.name]), onChange:(e)=>{
                    const next = JSON.parse(JSON.stringify(active)); if(!next.digital) next.digital = {}; next.digital[it.name] = e.target.checked; setEvent(next);
                  }}),
                  it.name
                ),
                React.createElement('div',null, EUR(it.unitPrice))
              ));
            });
            return out;
          })(),
          React.createElement('div',{className:'row', style:{justifyContent:'flex-end', marginTop:16}},
            React.createElement('strong', null, 'Totale DIGITAL: ', EUR(digitalSum(active)))
          )
        ),

        React.createElement(RoomsAdder,{active, setEvent, addRoom}),

        ...(active.rooms||[]).map(room=>React.createElement(RoomSection,{ key:room, room, active, setEvent, updateQty, removeItem, removeRoom, addItemToRoom })),

        React.createElement('div',{className:'row', style:{justifyContent:'flex-end', marginTop:16}},
          React.createElement('div',{className:'right'},
            React.createElement('div', null, 'Totale DIGITAL: ', React.createElement('strong', null, EUR(digitalSum(active)))),
            React.createElement('div', null, 'Totale evento: ',  React.createElement('strong', null, EUR(totalEvent)))
          )
        )
      ) : React.createElement('p',{className:'muted'}, 'Nessun evento selezionato.')
    ),
    React.createElement('p',{className:'muted'}, 'Dati salvati automaticamente sul dispositivo (localStorage).')
  );
}

function RoomsAdder({active, setEvent, addRoom}){
  const GROUND_ROOMS = [
    "CASTELLO 1","CASTELLO 2","ARCO","TEMPIO 1","TEMPIO 2","PIAZZA",
    "FOYER A","DOMUS","CONVIVIO","BISTROT","BK 1","BK 2","BK 3"
  ];
  const FIRST_ROOMS = [
    "PONTE 1","PONTE 2","PORTO","ARENGO","ANFI 1","ANFI 2","BORGO 1","BORGO 2",
    "PARCO 1","PARCO 2","MARINA 1","MARINA 2","V. PESCHERIA","FARO","FONTANA",
    "LAVATOIO","BASTIONI","SQUERO","OROLOGIO","BK 4","BK 5","BK 6","BK 7","BK8","BK 9"
  ];
  const [floor,setFloor] = React.useState(null);
  const toggleFloor = (which)=> setFloor(prev => prev===which ? null : which);
  const rooms = floor === 'PT' ? GROUND_ROOMS : (floor === 'PP' ? FIRST_ROOMS : []);

  return React.createElement('div', {className:'rooms-adder'},
    React.createElement('h2',{className:'addRoomBtn'},'AGGIUNGI SALA'),
    React.createElement('div',{className:'row floors-row'},
      React.createElement('button',{className:'pill pianoBtn', onClick:()=>toggleFloor('PT')}, 'PIANO TERRA'),
      React.createElement('button',{className:'pill pianoBtn', onClick:()=>toggleFloor('PP')}, 'PRIMO PIANO')
    ),
    rooms.length ? React.createElement('div',{className:'row choices-row', style:{flexWrap:'wrap'}},
      ...rooms.map(r=>React.createElement('button',{
        key:r,
        className:'pill',
        disabled: active.rooms.includes(r),
        onClick:()=>addRoom(r)
      }, r))
    ) : null
  );
}

function RoomSection({room, active, setEvent, updateQty, removeItem, removeRoom, addItemToRoom}){
  const CATS = ['AUDIO','VIDEO','LUCI','VARIO'];
  const [open,setOpen] = React.useState(false);
  const [activeCat,setActiveCat] = React.useState(null);
  const [justAdded, setJustAdded] = React.useState(null);

  const isGrouped = Boolean((active.groupedRooms||{})[room]);
  const isCollapsed = Boolean((active.collapsedRooms||{})[room]);

  function toggleGrouped(){
    const next = deepClone(active);
    if(!next.groupedRooms) next.groupedRooms = {};
    next.groupedRooms[room] = !Boolean(next.groupedRooms[room]);
    setEvent(next);
  }
  function toggleCollapsed(){
    const next = deepClone(active);
    if(!next.collapsedRooms) next.collapsedRooms = {};
    next.collapsedRooms[room] = !Boolean(next.collapsedRooms[room]);
    setEvent(next);
  }

  function toggleCat(cat){
    if(activeCat === cat){ setOpen(!open); }
    else { setActiveCat(cat); setOpen(true); }
  }
  function selectItem(it){ it = Object.assign({}, it, {_category: activeCat}); addItemToRoom(room, it); setOpen(false); try{ setJustAdded(it.name); setTimeout(()=>setJustAdded(null), 900); }catch(e){} }

  const items = active.itemsByRoom[room]||[];
  const totalRoom = items.reduce((a,it)=> a + Number(it.qty||0)*Number(it.unitPrice||0), 0);
  const catItems = activeCat ? (CATEGORY_CATALOG[activeCat]||[]) : [];

  function renderItemCard(it, neutral){
    const cls = neutral ? 'itemCard' : ('itemCard ' + (it.category ? ('cat-' + String(it.category).toLowerCase()) : ''));
    return React.createElement('div',{key:it.id, className:cls},
      React.createElement('div',null,
        React.createElement('div',null, it.name),
        React.createElement('div',{className:'muted'}, 'Prezzo: ', EUR(it.unitPrice))
      ),
      React.createElement('div',{className:'row'},
        React.createElement('input',{value:it.qty, style:{width:'90px'}, className:'right', onChange:(e)=>{
          const qty = Number((e.target.value||'').replace(',','.'))||0;
          updateQty(room, it.id, qty);
        }}),
        React.createElement('div',{style:{minWidth:'90px', textAlign:'right'}}, EUR((Number(it.qty||0)*Number(it.unitPrice||0)))),
        React.createElement('button',{className:'pill', onClick:()=>removeItem(room, it.id)}, 'Rimuovi')
      )
    );
  }

  return React.createElement('div',{className:'card roomCard'},
    React.createElement('div',{className:'roomHeader'},
      React.createElement('h2',{onClick:toggleCollapsed}, room),
    (justAdded ? React.createElement('div',{className:'addedToast'}, 'âœ“ Aggiunto: ', justAdded) : null),
      React.createElement('div',{className:'row', style:{gap:8}},
        !isCollapsed && React.createElement('button',{className:'pill btn-raggruppa-materiali', onClick:toggleGrouped}, isGrouped ? 'VISTA LISTA' : 'RAGGRUPPA MATERIALI'),
        React.createElement('button',{className:'pill btn-remove-sala', onClick:()=>removeRoom(room)}, 'RIMUOVI SALA ðŸ—‘ï¸')
      )
    ),
    !isCollapsed && React.createElement(React.Fragment,null,
      React.createElement('div',{className:'row', style:{gap:8, marginTop:4}},
        ...CATS.map(cat=>React.createElement('button',{
          key:cat,
          className: 'pill ' + (activeCat===cat? 'primary ' : '') + ('catbtn-' + String(cat).toLowerCase()),
          onClick:()=>toggleCat(cat)
        }, cat))
      ),
      React.createElement('div',{className:'row', style:{position:'relative', width:'100%', marginTop:8}},
        open && activeCat ? React.createElement('div',{className:'menu'},
          (catItems.length ? catItems : [{name:'â€” Nessun materiale â€”', unitPrice:0, _disabled:true}])
            .map(it=>React.createElement('button',{
              key:it.name,
              onClick:()=>{ if(!it._disabled) selectItem(it); },
              disabled: Boolean(it._disabled)
            }, `${it.name}${it._disabled? '' : ' â€” â‚¬ ' + it.unitPrice}`))
        ) : null
      ),
      (function renderItems(){
        const containerProps = {style:{marginTop:'10px'}};
        if(!isGrouped){
          return React.createElement('div', containerProps,
            ...items.map(it => renderItemCard(it, true))
          );
        }
        const ORDER = ['AUDIO','VIDEO','LUCI','VARIO'];
        const byCat = ORDER.map(cat => ({
          cat, list: items.filter(it => String(it.category||'VARIO').toUpperCase() === cat)
        })).filter(g => g.list.length);

        return React.createElement('div', containerProps,
          ...byCat.map(g =>
            React.createElement('div', {key:g.cat, className:'catGroup cat-' + g.cat.toLowerCase()},
              React.createElement('div', {className:'catHeader'}, g.cat),
              ...g.list.map(it => renderItemCard(it, true))
            )
          )
        );
      })(),
      React.createElement('div',{className:'row', style:{justifyContent:'flex-end', marginTop:'16px'}},
        React.createElement('strong',null, 'Totale ', room, ': ', EUR(totalRoom))
      )
    )
  );
}

ReactDOM.createRoot(document.getElementById('root')).render(React.createElement(App));
</script>

<style>
  #exportPdfBtn{
    position: fixed; right: 20px; bottom: 20px;
    padding: 10px 14px; border-radius: 9999px; border: none;
    box-shadow: 0 6px 20px rgba(0,0,0,0.15); cursor: pointer; font-weight: 600;
  }

  .addedToast{
    position: relative;
    display:inline-flex;
    align-items:center;
    gap:6px;
    background:#0b1220;
    border:1px solid #22c55e;
    color:#22c55e;
    padding:6px 10px;
    border-radius:999px;
    font-weight:700;
    font-size:12px;
    box-shadow:0 4px 12px rgba(0,0,0,.25);
    margin: 6px 0 0 0;
  }

  /* Colori bordo per gruppi categoria (vista raggruppata) */
  .catGroup{ padding:10px; border-radius:10px; margin:10px 0; }
  .catGroup .catHeader{ font-weight:800; margin-bottom:8px; }
  .catGroup.cat-audio { border: 2px solid #ff0000 !important; }
  .catGroup.cat-video { border: 2px solid #00bfff !important; }
  .catGroup.cat-luci  { border: 2px solid #ffffff !important; }
  .catGroup.cat-vario { border: 2px solid #32cd32 !important; }
</style>
<button id="exportPdfBtn" title="Esporta in PDF">Esporta PDF</button>

<script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/jspdf-autotable@3.8.2/dist/jspdf.plugin.autotable.min.js"></script>

<script>
(function(){
  const EURfmt = (v)=>{
    try{ return new Intl.NumberFormat('it-IT',{style:'currency',currency:'EUR'}).format(Number(v||0)); }
    catch(e){ return (Number(v||0)).toFixed(2) + ' â‚¬'; }
  };

  function getEventNameFromDOM(){
    const labels = Array.from(document.querySelectorAll('label'));
    for(const lab of labels){
      if(lab.textContent && lab.textContent.trim().toLowerCase().startsWith('nome')){
        const el = lab.nextElementSibling;
        if(el && el.tagName === 'INPUT'){
          const val = el.value || el.getAttribute('value') || '';
          if(val) return val.trim();
        }
      }
    }
    const h = document.querySelector('.event-name, header h1, h1');
    if(h && h.textContent) return h.textContent.trim();
    return document.title || 'EVENTO';
  }

  function normA(s){ return String(s||'').replace(/\s*-\s*/g,'-').replace(/\s+/g,' ').trim().toUpperCase(); }
  function normB(s){ return String(s||'').replace(/\s*\-\s*/g,' - ').replace(/\s+/g,' ').trim().toUpperCase(); }
  function normC(s){ return String(s||'').replace(/\s+/g,' ').trim().toUpperCase(); }

  function buildPriceMap(){
    let catalog = [];
    try{
      if (Array.isArray(window.CATALOG)) catalog = window.CATALOG;
      else if (typeof CATALOG !== 'undefined' && Array.isArray(CATALOG)) catalog = CATALOG;
    }catch(e){}
    const map = {};
    catalog.forEach(it => {
      const n1 = normA(it.name), n2 = normB(it.name), n3 = normC(it.name);
      map[n1] = Number(it.unitPrice||0);
      map[n2] = Number(it.unitPrice||0);
      map[n3] = Number(it.unitPrice||0);
    });
    return { map, catalog };
  }

  function getPrice(name, map, catalog){
    const k1 = normA(name), k2 = normB(name), k3 = normC(name);
    if(map[k1] != null) return map[k1];
    if(map[k2] != null) return map[k2];
    if(map[k3] != null) return map[k3];
    for(const it of catalog){
      const cn = normA(it.name);
      if(cn === k1 || cn === k3) return Number(it.unitPrice||0);
    }
    return 0;
  }

  function readStateModel(){
    try{ if(typeof window.__getModel === 'function'){ const m = window.__getModel(); if(m && m.name){ return m; } } }catch(e){}
    if(window.__CONSUNTIVO && Array.isArray(window.__CONSUNTIVO.events)){
      const { events, activeId } = window.__CONSUNTIVO;
      let ev = null;
      if(activeId) ev = events.find(e=>e.id===activeId) || null;
      if(!ev){
        const name = getEventNameFromDOM();
        ev = events.find(e=>String(e.name).trim()===String(name).trim()) || events[0] || null;
      }
      if(ev){
        return { name: ev.name||'EVENTO', rooms: ev.rooms||[], itemsByRoom: ev.itemsByRoom||{}, digital: ev.digital||{} };
      }
    }
    try{
      const raw = localStorage.getItem('consuntivo_state_v1');
      if(raw){
        const parsed = JSON.parse(raw);
        if(parsed && Array.isArray(parsed.events) && parsed.events.length){
          const name = getEventNameFromDOM();
          let ev = parsed.events.find(e=>String(e.name).trim()===String(name).trim()) || parsed.events[0];
          return { name: ev.name||'EVENTO', rooms: ev.rooms||[], itemsByRoom: ev.itemsByRoom||{}, digital: ev.digital||{} };
        }
      }
    }catch(e){}
    return { name:getEventNameFromDOM(), rooms:[], itemsByRoom:{}, digital:{} };
  }

  function exportPDF(){
    const { jsPDF } = window.jspdf || {};
    if(!jsPDF){ alert('Libreria jsPDF non caricata.'); return; }

    const { map: priceMap, catalog } = buildPriceMap();

    const doc = new jsPDF('p','pt','a4');
    const pageH = doc.internal.pageSize.getHeight();
    const pageW = doc.internal.pageSize.getWidth();
    const marginX = 40;
    let y = 60;

    const model = readStateModel();
    const title = model.name || 'EVENTO';

    // Titolo con rettangolo (solo bordo), allineato con tabelle e centrato
    doc.setFontSize(18);
    doc.setFont(undefined, 'bold');
    doc.setTextColor(0, 0, 0);
    const padY = 8;
    const th = 1.2 * doc.getFontSize();
    const titleWidth = doc.getTextWidth(String(title)) + 40;
    const titleHeight = 28;
    const rectX = marginX;
    const rectY = y + padY - 20;
    doc.setDrawColor(0,0,0);
    doc.rect(rectX, rectY, titleWidth, titleHeight); // solo bordo
    const textX = rectX + titleWidth/2 - doc.getTextWidth(String(title))/2;
    const textY = rectY + titleHeight/2 + 5;
    doc.text(String(title), textX, textY);
    y += th + 2*padY + 6;

    // DIGITAL rows
    let totalDigital = 0;
    const digitalRows = [];
    try{
      if (model.digital) {
        Object.keys(model.digital).forEach(name => {
          if(model.digital[name]){
            const unit = getPrice(name, priceMap, catalog);
            digitalRows.push({ name, unitPrice: unit, qty: 1 });
          }
        });
      }
    }catch(e){}

    const roomNames = (model.rooms || []).filter(r => r && r.toUpperCase() !== 'DIGITAL');
    const ordered = [];
    if(digitalRows.length) ordered.push('DIGITAL');
    ordered.push(...roomNames);

    let totalRooms = 0;

    for(const room of ordered){
      let items = [];
      if(room === 'DIGITAL'){
        items = digitalRows;
      }else{
        items = (model.itemsByRoom[room] || []).map(it => ({
          name: it.name,
          unitPrice: Number(it.unitPrice||0),
          qty: Number(it.qty||0)
        }));
      }

      const filtered = items.filter(it => Number(it.qty||0) > 0);
      if(!filtered.length) continue;

      const isDigital = (room === 'DIGITAL');
      const headColor = isDigital ? [59,130,246] : [34,197,94];
      const headLabel = isDigital ? 'DIGITAL' : `Sala: ${room}`;

      const body = filtered.map(it=>{
        const qty = Number(it.qty||0);
        const tot = qty * Number(it.unitPrice||0);
        const cleanName = String(it.name || '').trim();
        return [cleanName, EURfmt(it.unitPrice), qty, EURfmt(tot)];
      });
      const roomSum = filtered.reduce((a,it)=> a + Number(it.qty||0)*Number(it.unitPrice||0), 0);

      doc.autoTable({
        startY: y + 10,
        head: [[ headLabel, 'Prezzo', 'Q.tÃ ', 'Totale riga' ]],
        body,
        theme: 'grid',
        styles: { fontSize: 9, cellPadding: 4 },
        headStyles: { fillColor: headColor },
        columnStyles: { 1:{halign:'right'}, 2:{halign:'right'}, 3:{halign:'right'} },
      });

      y = doc.lastAutoTable.finalY || y;

      doc.setFontSize(10);
      doc.setFont(undefined,'bold');
      doc.text(`Totale ${isDigital ? 'DIGITAL' : room}: ${EURfmt(roomSum)}`, marginX, y + 16);
      y += 28;

      if(isDigital) totalDigital += roomSum; else totalRooms += roomSum;

      if(y > pageH - 100){
        doc.addPage(); y = 60;
        doc.setFontSize(18);
        doc.text(String(title), marginX, y);
        y += 20;
      }
    }

    const eventTotal = totalDigital + totalRooms;
    doc.setFontSize(12);
    doc.setFont(undefined,'bold');
    const footerY = y + 30;
    doc.text(`Totale evento: ${EURfmt(eventTotal)}`, pageW - marginX, footerY, { align: 'right' });

    const safeName = String(title).trim().replace(/\s+/g,'_').replace(/[^\w\-_.]/g,'');
    doc.save(`CONSUNTIVO EVENTO - ${safeName||'EVENTO'}.pdf`);
  }

  document.addEventListener('DOMContentLoaded', ()=>{
    const btn = document.getElementById('exportPdfBtn');
    if(btn) btn.addEventListener('click', exportPDF);
  });
})();
</script>
</body>
</html>
